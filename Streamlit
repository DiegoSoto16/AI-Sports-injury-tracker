import streamlit as st
import pandas as pd
import datetime
import requests
from streamlit_calendar import calendar
from typing import Dict

# ------------------------ Session State ------------------------

if "events" not in st.session_state:
    st.session_state.events = []

if "user_profile" not in st.session_state:
    st.session_state.user_profile = {
        "name": "Athlete One",
        "age": 25,
        "sport": "Soccer",
        "training_goal": "Injury Prevention & Performance",
    }

# ------------------------ Sidebar Navigation ------------------------

st.sidebar.title("Navigation")
page = st.sidebar.radio("Go to", ["ğŸ  Dashboard", "ğŸ“… Calendar", "ğŸ§  AI Prevention", "âŒš Wearable Devices", "ğŸ‘¤ Profile"])

# ------------------------ Local AI Prevention Logic ------------------------

def generate_ai_prevention_advice(data: Dict) -> Dict:
    if data["heart_rate"] > 160 or data["fatigue_level"] > 8:
        return {
            "risk_score": 0.85,
            "advice": [
                "Your heart rate and fatigue levels suggest overtraining.",
                "Take a recovery day and hydrate well.",
                "Avoid intense sessions until metrics stabilize."
            ]
        }
    elif data["sleep_hours"] < 6 or data["fatigue_level"] > 6:
        return {
            "risk_score": 0.6,
            "advice": [
                "You're moderately fatiguedâ€”consider a lighter workout.",
                "Prioritize sleep and hydration tonight.",
                "Mobility or low-impact cardio is ideal today."
            ]
        }
    else:
        return {
            "risk_score": 0.2,
            "advice": [
                "Metrics look goodâ€”you're ready to train.",
                "Stick to your plan and monitor recovery.",
                "Keep syncing your wearable for better insights."
            ]
        }

# ------------------------ Pages ------------------------

#ğŸ Dashboard Page
if page == "ğŸ  Dashboard":
    st.title("ğŸ“Š Health Dashboard")

    # Fetch wearable data from backend
    try:
        response = requests.get("http://localhost:8000/api/metrics/")
        if response.status_code == 200:
            st.session_state.wearable_data = response.json()
        else:
            st.warning("Using default data. Backend returned error.")
            st.session_state.wearable_data = {
                "heart_rate": 82,
                "fatigue_level": 4,
                "steps": 8300,
                "sleep_hours": 7.5
            }
    except Exception as e:
        st.error(f"Backend connection error: {e}")
        st.session_state.wearable_data = {
            "heart_rate": 82,
            "fatigue_level": 4,
            "steps": 8300,
            "sleep_hours": 7.5
        }

    data = st.session_state.wearable_data

    col1, col2 = st.columns(2)
    with col1:
        st.metric("Heart Rate", data["heart_rate"])
        st.metric("Fatigue Level", data["fatigue_level"])
    with col2:
        st.metric("Steps Today", data["steps"])
        st.metric("Sleep Hours", data["sleep_hours"])

    st.subheader("ğŸ“ˆ Heart Rate Trend")
    hr_df = pd.DataFrame({
        "Date": pd.date_range(end=pd.Timestamp.today(), periods=7),
        "Heart Rate": [78, 80, 82, 79, 81, 83, data["heart_rate"]]
    })
    st.line_chart(hr_df.set_index("Date"))

    st.subheader("ğŸ˜´ Sleep Quality Trend")
    sleep_df = pd.DataFrame({
        "Date": pd.date_range(end=pd.Timestamp.today(), periods=7),
        "Sleep Hours": [6.5, 7.0, 7.5, 6.0, 8.0, 7.2, data["sleep_hours"]]
    })
    st.bar_chart(sleep_df.set_index("Date"))

#ğŸ“…Calendar Page
elif page == "ğŸ“… Calendar":
    st.title("ğŸ“… Training & Recovery Calendar")

    st.subheader("Add Event")
    event_title = st.text_input("Event Title")
    event_date = st.date_input("Event Date", datetime.date.today())

    if st.button("Add Event"):
        st.session_state.events.append({
            "title": event_title,
            "start": str(event_date),
            "end": str(event_date)
        })
        st.success(f"Event '{event_title}' added on {event_date}.")

    st.subheader("Calendar View")
    if not st.session_state.events:
        st.session_state.events.append({
            "title": "Sample Event",
            "start": str(datetime.date.today()),
            "end": str(datetime.date.today())
        })

    try:
        calendar(events=st.session_state.events)
    except Exception as e:
        st.error(f"Calendar failed to load: {e}")

#ğŸ§ AI Prevention Advice Page
elif page == "ğŸ§  AI Prevention":
    st.title("ğŸ§  AI-Powered Injury Prevention")

    st.subheader("ğŸ“¡ Wearable Metrics")
    wearable_data = st.session_state.get("wearable_data", {
        "heart_rate": 82,
        "fatigue_level": 4,
        "sleep_hours": 7.5
    })

    for k, v in wearable_data.items():
        if k != "steps":
            st.metric(label=k.replace("_", " ").title(), value=v)

    # Try fetching AI advice from backend
    try:
        response = requests.post("http://localhost:8000/api/advice/", json=wearable_data)
        if response.status_code == 200:
            ai_response = response.json()
        else:
            st.warning("Using local AI logic. Backend advice failed.")
            ai_response = generate_ai_prevention_advice(wearable_data)
    except Exception as e:
        st.error(f"Advice fetch error: {e}")
        ai_response = generate_ai_prevention_advice(wearable_data)

    risk_score = ai_response["risk_score"]
    st.metric("Injury Risk Score", f"{risk_score*100:.1f} %")

    st.subheader("ğŸ©º Smart Training Advice")
    if risk_score > 0.7:
        st.error("âš ï¸ High risk detected. Recovery recommended:")
    elif risk_score > 0.4:
        st.warning("ğŸŸ¡ Moderate risk. Adjust training accordingly:")
    else:
        st.success("ğŸŸ¢ Low risk. You're cleared for training!")

    for tip in ai_response["advice"]:
        st.write(f"- {tip}")

#âŒšWearable Devices Page
elif page == "âŒš Wearable Devices":
    st.title("âŒš Connected Wearable Devices")

    st.markdown("**Connected Devices:**")
    connected_devices = ["Fitbit Charge 5", "Apple Watch Series 8"]
    for device in connected_devices:
        st.write(f"- {device}")

    st.markdown("---")
    st.subheader("Simulate Data Upload")
    if st.button("Send Data to Backend"):
        try:
            payload = st.session_state.get("wearable_data", {})
            response = requests.post("http://localhost:8000/api/metrics/", json=payload)
            if response.status_code == 201:
                st.success("âœ… Data sent to backend!")
            else:
                st.error("âŒ Failed to send data.")
        except Exception as e:
            st.error(f"Error sending data: {e}")

#ğŸ‘¤Profile Page
elif page == "ğŸ‘¤ Profile":
    st.title("ğŸ‘¤ User Profile")

    profile = st.session_state.user_profile

    name = st.text_input("Name", value=profile["name"])
    age = st.number_input("Age", min_value=10, max_value=100, value=profile["age"])
    sport = st.text_input("Sport", value=profile["sport"])
    goal = st.text_input("Training Goal", value=profile["training_goal"])

    if st.button("Update Profile"):
        st.session_state.user_profile = {
            "name": name,
            "age": age,
            "sport": sport,
            "training_goal": goal,
        }
        st.success("âœ… Profile updated!")

    st.markdown("### Current Profile")
    for k, v in st.session_state.user_profile.items():
        st.write(f"**{k.title()}**: {v}")
